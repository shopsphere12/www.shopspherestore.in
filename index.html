<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friend Chat (Discord Clone)</title>
  <style>
    /* =======================
       RESET + BASE
    ======================= */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#202225; color:#fff; display:flex; height:100vh; }
    button { cursor:pointer; }

    /* =======================
       LAYOUT
    ======================= */
    .sidebar {
      width: 250px;
      background: #2f3136;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    .sidebar h2 {
      color: #b9bbbe;
      margin-bottom: 10px;
    }
    .channels, .groups {
      flex:1;
      overflow-y:auto;
      margin-bottom:10px;
    }
    .channel, .group {
      padding: 8px;
      margin: 3px 0;
      border-radius:5px;
      cursor:pointer;
    }
    .channel:hover, .group:hover {
      background:#3a3c42;
    }
    .active {
      background:#5865f2;
    }
    .sidebar-footer {
      display:flex;
      gap:5px;
    }
    .sidebar-footer button {
      flex:1;
      padding:6px;
      border:none;
      border-radius:5px;
      background:#5865f2;
      color:white;
      font-size:14px;
    }
    .sidebar-footer button.ghost {
      background:#3a3c42;
    }

    /* =======================
       CHAT AREA
    ======================= */
    .chat {
      flex:1;
      display:flex;
      flex-direction:column;
      background:#36393f;
    }
    .chat-header {
      background:#2f3136;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .chat-messages {
      flex:1;
      padding:15px;
      overflow-y:auto;
    }
    .message {
      margin-bottom:10px;
    }
    .message strong { color:#dcddde; }
    .chat-input {
      display:flex;
      padding:10px;
      background:#40444b;
    }
    .chat-input input {
      flex:1;
      padding:10px;
      border:none;
      border-radius:5px;
      outline:none;
    }
    .chat-input button {
      margin-left:10px;
      padding:10px 15px;
      border:none;
      border-radius:5px;
      background:#5865f2;
      color:white;
    }

    /* =======================
       MODALS
    ======================= */
    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .hidden { display:none; }
    .modal .box {
      background:#2f3136;
      padding:20px;
      border-radius:10px;
      width:300px;
      text-align:center;
    }
    .modal .box input {
      width:100%;
      margin:5px 0;
      padding:8px;
      border:none;
      border-radius:5px;
    }
    .modal .box button {
      margin-top:10px;
      padding:8px 12px;
      border:none;
      border-radius:5px;
      background:#5865f2;
      color:white;
    }

    /* =======================
       CALL MODAL
    ======================= */
    #callModal .modal-content {
      background:#2f3136;
      padding:15px;
      border-radius:10px;
      text-align:center;
      width:500px;
    }
    #localVideo, #remoteVideo {
      width:45%;
      margin:5px;
      border-radius:8px;
      background:black;
    }
    #endCallBtn {
      margin-top:10px;
      background:red;
      border:none;
      padding:8px 15px;
      border-radius:5px;
      color:white;
    }
  </style>
</head>
<body>
  <!-- =======================
       SIDEBAR
  ======================= -->
  <div class="sidebar">
    <h2>Groups</h2>
    <div id="groupsList" class="groups"></div>
    <h2>Channels</h2>
    <div id="channelsList" class="channels"></div>
    <div class="sidebar-footer">
      <button id="openCreateGroup">+ Group</button>
      <button id="openJoinGroup" class="ghost">Join</button>
      <button id="openCreateChannel" class="ghost">+ Channel</button>
    </div>
  </div>

  <!-- =======================
       CHAT AREA
  ======================= -->
  <div class="chat">
    <div class="chat-header">
      <span id="channelName">#general</span>
      <button id="startCallBtn">ðŸ“ž Call</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- =======================
       MODALS
  ======================= -->
  <!-- Create Group -->
  <div id="createGroupModal" class="modal hidden">
    <div class="box">
      <h3>Create Group</h3>
      <input id="newGroupName" placeholder="Group name">
      <input id="newGroupPassword" placeholder="Password">
      <button id="confirmGroupCreate">Create</button>
      <button id="cancelGroupCreate">Cancel</button>
    </div>
  </div>

  <!-- Join Group -->
  <div id="joinGroupModal" class="modal hidden">
    <div class="box">
      <h3>Join Group</h3>
      <input id="joinGroupName" placeholder="Group name">
      <input id="joinGroupPassword" placeholder="Password">
      <button id="confirmJoinGroup">Join</button>
      <button id="cancelJoinGroup">Cancel</button>
    </div>
  </div>

  <!-- Create Channel -->
  <div id="createChannelModal" class="modal hidden">
    <div class="box">
      <h3>Create Channel</h3>
      <input id="newChannelName" placeholder="Channel name">
      <button id="confirmChannelCreate">Create</button>
      <button id="cancelChannelCreate">Cancel</button>
    </div>
  </div>

  <!-- Call Modal -->
  <div id="callModal" class="modal hidden">
    <div class="modal-content">
      <h3>Voice/Video Call</h3>
      <video id="localVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
      <br>
      <button id="endCallBtn">End Call</button>
    </div>
  </div>

  <!-- =======================
       FIREBASE + APP LOGIC
  ======================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      const firebaseConfig = {
  apiKey: "AIzaSyD0OAOSTic5z4U4obChkOieVLtvhgmIfxU", // <--- You'll get this from the console
  authDomain: "friend-chat-eaabe.firebaseapp.com",
  databaseURL: "https://friend-chat-eaabe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "friend-chat-eaabe",
  storageBucket: "friend-chat-eaabe.appspot.com",
  messagingSenderId: "409498465855",
  appId: "1:409498465855:web:bfec1da1a2f29a1f73aa8a" // <--- You'll get this from the console
};

// Example of how you'd use it:
// import { initializeApp } from "firebase/app";
// const app = initializeApp(firebaseConfig);

    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elements
    const groupsList = document.getElementById("groupsList");
    const channelsList = document.getElementById("channelsList");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const channelName = document.getElementById("channelName");

    // Modal buttons
    const openCreateGroupBtn = document.getElementById("openCreateGroup");
    const createGroupModal = document.getElementById("createGroupModal");
    const confirmGroupCreateBtn = document.getElementById("confirmGroupCreate");
    const cancelGroupCreateBtn = document.getElementById("cancelGroupCreate");
    const newGroupNameInput = document.getElementById("newGroupName");
    const newGroupPasswordInput = document.getElementById("newGroupPassword");

    const openJoinGroupBtn = document.getElementById("openJoinGroup");
    const joinGroupModal = document.getElementById("joinGroupModal");
    const confirmJoinGroupBtn = document.getElementById("confirmJoinGroup");
    const cancelJoinGroupBtn = document.getElementById("cancelJoinGroup");
    const joinGroupNameInput = document.getElementById("joinGroupName");
    const joinGroupPasswordInput = document.getElementById("joinGroupPassword");

    const openCreateChannelBtn = document.getElementById("openCreateChannel");
    const createChannelModal = document.getElementById("createChannelModal");
    const confirmChannelCreateBtn = document.getElementById("confirmChannelCreate");
    const cancelChannelCreateBtn = document.getElementById("cancelChannelCreate");
    const newChannelNameInput = document.getElementById("newChannelName");

    // Current state
    let currentGroup = null;
    let currentChannel = "general";

    /* =======================
       MODAL HELPERS
    ======================= */
    function showModal(modal) { modal.classList.remove("hidden"); }
    function hideModal(modal) { modal.classList.add("hidden"); }

    /* =======================
       GROUP CREATION
    ======================= */
    openCreateGroupBtn.addEventListener("click", () => showModal(createGroupModal));
    cancelGroupCreateBtn.addEventListener("click", () => hideModal(createGroupModal));

    confirmGroupCreateBtn.addEventListener("click", async () => {
      const g = newGroupNameInput.value.trim();
      const pw = newGroupPasswordInput.value.trim();
      if (!g || !pw) return alert("Enter group name & password");
      await set(ref(db, `groups/${g}/password`), pw);
      await set(ref(db, `groups/${g}/channels/general`), true);
      hideModal(createGroupModal);
      loadGroups();
    });

    /* =======================
       GROUP JOIN
    ======================= */
    openJoinGroupBtn.addEventListener("click", () => showModal(joinGroupModal));
    cancelJoinGroupBtn.addEventListener("click", () => hideModal(joinGroupModal));

    confirmJoinGroupBtn.addEventListener("click", async () => {
      const g = joinGroupNameInput.value.trim();
      const pw = joinGroupPasswordInput.value.trim();
      if (!g || !pw) return;
      onValue(ref(db, `groups/${g}/password`), (snap) => {
        if (snap.exists() && snap.val() === pw) {
          currentGroup = g;
          loadChannels(g);
          selectChannel("general");
          hideModal(joinGroupModal);
        } else {
          alert("Wrong group or password");
        }
      }, { onlyOnce:true });
    });

    /* =======================
       CHANNEL CREATION
    ======================= */
    openCreateChannelBtn.addEventListener("click", () => {
      if (!currentGroup) return alert("Join or create a group first");
      showModal(createChannelModal);
    });
    cancelChannelCreateBtn.addEventListener("click", () => hideModal(createChannelModal));
    confirmChannelCreateBtn.addEventListener("click", async () => {
      const ch = newChannelNameInput.value.trim();
      if (!ch) return;
      await set(ref(db, `groups/${currentGroup}/channels/${ch}`), true);
      hideModal(createChannelModal);
      loadChannels(currentGroup);
    });

    /* =======================
       LOAD GROUPS & CHANNELS
    ======================= */
    function loadGroups() {
      groupsList.innerHTML = "";
      onValue(ref(db, "groups"), (snapshot) => {
        groupsList.innerHTML = "";
        snapshot.forEach(child => {
          const g = child.key;
          const div = document.createElement("div");
          div.className = "group";
          div.textContent = g;
          div.onclick = () => { currentGroup = g; loadChannels(g); selectChannel("general"); };
          groupsList.appendChild(div);
        });
      });
    }

    function loadChannels(g) {
      channelsList.innerHTML = "";
      onValue(ref(db, `groups/${g}/channels`), (snapshot) => {
        channelsList.innerHTML = "";
        snapshot.forEach(child => {
          const ch = child.key;
          const div = document.createElement("div");
          div.className = "channel";
          div.textContent = "#" + ch;
          div.onclick = () => selectChannel(ch);
          channelsList.appendChild(div);
        });
      });
    }

    /* =======================
       MESSAGES
    ======================= */
    function selectChannel(ch) {
      currentChannel = ch;
      channelName.textContent = "#" + ch;
      chatMessages.innerHTML = "";
      onValue(ref(db, `groups/${currentGroup}/channels/${ch}/messages`), (snapshot) => {
        chatMessages.innerHTML = "";
        snapshot.forEach(child => {
          const msg = child.val();
          const div = document.createElement("div");
          div.className = "message";
          div.innerHTML = `<strong>${msg.name}:</strong> ${msg.text}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    sendBtn.addEventListener("click", () => {
      const text = chatInput.value.trim();
      if (!text || !currentGroup || !currentChannel) return;
      push(ref(db, `groups/${currentGroup}/channels/${currentChannel}/messages`), {
        name: "User",
        text
      });
      chatInput.value = "";
    });

    /* =======================
       WEBRTC CALLING
    ======================= */
    let localStream;
    let peerConnection;
    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    const startCallBtn = document.getElementById("startCallBtn");
    const callModal = document.getElementById("callModal");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const endCallBtn = document.getElementById("endCallBtn");

    async function startCall() {
      callModal.classList.remove("hidden");
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };
      const callPath = `groups/${currentGroup}/calls/${currentChannel}`;
      peerConnection.onicecandidate = (event) => { if (event.candidate) push(ref(db, `${callPath}/candidates`), event.candidate.toJSON()); };
      const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer);
      await set(ref(db, `${callPath}/offer`), { sdp: offer.sdp, type: offer.type });
      onValue(ref(db, `${callPath}/answer`), async (snap) => { if (snap.exists() && !peerConnection.currentRemoteDescription) await peerConnection.setRemoteDescription(snap.val()); });
      onValue(ref(db, `${callPath}/candidates`), (snap) => { snap.forEach(async child => { try { await peerConnection.addIceCandidate(new RTCIceCandidate(child.val())); } catch(e){} }); });
    }

    async function joinCall() {
      callModal.classList.remove("hidden");
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };
      peerConnection.onicecandidate = (event) => { if (event.candidate) push(ref(db, `groups/${currentGroup}/calls/${currentChannel}/candidates`), event.candidate.toJSON()); };
      onValue(ref(db, `groups/${currentGroup}/calls/${currentChannel}/offer`), async (snap) => {
        if (snap.exists() && !peerConnection.currentRemoteDescription) {
          await peerConnection.setRemoteDescription(snap.val());
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          await set(ref(db, `groups/${currentGroup}/calls/${currentChannel}/answer`), { sdp: answer.sdp, type: answer.type });
        }
      });
      onValue(ref(db, `groups/${currentGroup}/calls/${currentChannel}/candidates`), (snap) => { snap.forEach(async child => { try { await peerConnection.addIceCandidate(new RTCIceCandidate(child.val())); } catch(e){} }); });
    }

    function endCall() {
      callModal.classList.add("hidden");
      if (peerConnection) peerConnection.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      remoteVideo.srcObject = null; localVideo.srcObject = null;
    }

    startCallBtn.addEventListener("click", async () => {
      const offerRef = ref(db, `groups/${
